<h2>{{metadata.label}}</h2>

<form on:submit="submit(app, form, event)">
    {{#each form.inputFieldValues as inputField}}
    <FormInput field="{{inputField}}" tabindex="{{tabindex * 100 + inputField.metadata.orderIndex}}" />
    {{/each}}

    <button type="submit" disabled="{{disabled}}" tabindex="-1">submit</button>
</form>

{{#if outputFieldValues != null}}
<div class="response">
    {{#each outputFieldValues as outputField}}
    <FormOutput field="{{outputField}}"/>
    {{/each}}
</div>
{{/if}}

<script>
    import FormInput from "./input";
    import FormOutput from "./output";

    let tabindex = 1;

    function enableForm(form) {
        form.set({
            // Remove previous output, this is needed for repainting.
            outputFieldValues: null,

            // Enable post.
            disabled: false
        });
    }

    export default {
        oncreate() {
            tabindex += 1;

            var form = this.get("form");

            if (form.metadata.postOnLoad) {
                var app = this.get("app");
                this.submit(app, form);
            }
        },
        methods: {
            submit: function (app, formInstance, event) {
                var self = this;

                if (event != null) {
                    event.preventDefault();
                }

                // Ensure all required inputs were entered, before posting.
                var missingRequiredInputs = formInstance.inputFieldValues.filter(i => i.metadata.required && (i.data == null || i.data === ""));
                if (missingRequiredInputs.length > 0) {
                    return;
                }

                // Disable double-posts.
                self.set({ disabled: true });

                // Get input field values in a serialized format.
                var stateParameters = {};
                for (let inputField of formInstance.inputFieldValues.filter(t => t.data != null && t.data !== "")) {
                    stateParameters[inputField.metadata.id] = inputField.manager.serialize();
                }

                // Update url in the browser.
                app.go(formInstance.metadata.id, stateParameters);

                app.server.postForm(formInstance)
                    .then(response => {
                        formInstance.setOutputFieldValues(response);
                        
                        enableForm(self);

                        if (response.responseHandler == "" || response.responseHandler == null) {
                            self.set({
                                outputFieldValues: formInstance.outputFieldValues
                            });
                        }
                        else {
                            app.handleResponse(response, formInstance);
                        }
                    })
                    .catch(response => {
                        enableForm(self);
                    });
            }
        },
        data: function() {
            return {
                disabled: false,
                tabindex:tabindex
            };
        },
        components: {
            FormInput,
            FormOutput
        }
    };
</script>

<style>
    .response {margin-top:50px}
</style>